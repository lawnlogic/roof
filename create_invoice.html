<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Invoice • Deep Edge</title>
  <link rel="stylesheet" href="styles.css">
  <script src="header.js" defer></script>
</head>
<body>
  <div class="container" style="max-width: 640px;">
    <h2>Create Invoice</h2>
    <p style="color:#aaa; margin: -8px 0 24px 0;">
      Create invoice from existing quote
    </p>

    <!-- Quote Selection -->
    <div class="input-group">
      <label for="quote-select">Select Quote to Invoice</label>
      <select id="quote-select">
        <option value="">-- Choose a quote without invoice --</option>
      </select>
    </div>

    <!-- Invoice Details Form (hidden until quote selected) -->
    <div id="invoice-form" class="hidden">
      <div class="pricing-box" style="margin: 24px 0;">
        <div class="pricing-row">
          <span>Job Address:</span>
          <strong id="inv-address"></strong>
        </div>
        <div class="pricing-row">
          <span>Client:</span>
          <strong id="inv-client"></strong>
        </div>
        <div class="pricing-row">
          <span>Quote Amount (incl GST):</span>
          <strong id="inv-total"></strong>
        </div>
      </div>

      <!-- Invoice Specific Fields -->
      <div class="input-group">
        <label for="inv-number">Invoice Number</label>
        <input type="text" id="inv-number" placeholder="INV-2025-001" />
      </div>

      <div class="input-group">
        <label for="issue-date">Issue Date</label>
        <input type="date" id="issue-date" value="" />
      </div>

      <div class="input-group">
        <label for="due-date">Due Date</label>
        <input type="date" id="due-date" value="" />
      </div>

      <div class="input-group">
        <label for="payment-terms">Payment Terms</label>
        <select id="payment-terms">
          <option value="7">7 Days</option>
          <option value="14" selected>14 Days</option>
          <option value="20th-next">20th of following month</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="input-group">
        <label for="inv-notes">Notes / Payment Instructions</label>
        <textarea id="inv-notes" rows="4" placeholder="Bank account: 02-1234-5678901-00&#10;Please pay by internet banking. Thank you!"></textarea>
      </div>

      <button id="generate-invoice-btn" class="action-button" style="margin-top: 24px; width:100%;">
        Generate Invoice
      </button>
    </div>

    <div id="success-message" class="hidden" style="margin-top:32px; padding:20px; background:#1e3a2e; border-radius:12px; text-align:center;">
      <h3 style="margin:0 0 12px 0; color:#8B5CF6;">Invoice Created!</h3>
      <p id="invoice-link-text"></p>
      <a id="view-invoice-btn" class="quote-link-btn" style="display:inline-block; margin-top:16px;" target="_blank">View Invoice</a>
    </div>

    <div id="error-message" class="error hidden" style="margin-top:24px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzS6a2JbgFxSJLPi2-sWyflOfrE7jd73g",
      authDomain: "deep-edge-cc5bd.firebaseapp.com",
      projectId: "deep-edge-cc5bd",
      storageBucket: "deep-edge-cc5bd.firebasestorage.app",
      messagingSenderId: "23198790796",
      appId: "1:23198790796:web:616de764b8a8db2ae1f7a9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const WORKER_URL = "https://firebase-protected-backend.jamesisarad.workers.dev";

    const quoteSelect = document.getElementById('quote-select');
    const invoiceForm = document.getElementById('invoice-form');
    const generateBtn = document.getElementById('generate-invoice-btn');

    // Pre-fill dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issue-date').value = today;
    const due = new Date();
    due.setDate(due.getDate() + 14);
    document.getElementById('due-date').value = due.toISOString().split('T')[0];

    let currentUser = null;
    let selectedQuoteData = null; // ← Store full quote here when selected

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;

      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      const token = await user.getIdToken();

      try {
        const res = await fetch(`${WORKER_URL}/api/quotes`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error('Failed to load quotes');

        const { quotes = [] } = await res.json();

        quotes.forEach(q => {
          const option = document.createElement('option');
          option.value = q.id;
          option.textContent = `${q.data.address || 'No address'} — $${(q.data.lawnAreaM2 * q.data.ratePerM2 * 1.15 + q.data.calloutFee * 1.15).toFixed(2)}`;
          option.dataset.address = q.data.address || '';
          option.dataset.client = q.data.client ? `${q.data.client.firstName || ''} ${q.data.client.lastName || ''}` : '';
          option.dataset.total = (q.data.lawnAreaM2 * q.data.ratePerM2 * 1.15 + q.data.calloutFee * 1.15).toFixed(2);
          
          // Store full quote data in the option (as JSON string)
          option.dataset.fullQuote = JSON.stringify(q);
          
          quoteSelect.appendChild(option);
        });

      } catch (err) {
        document.getElementById('error-message').textContent = 'Error loading quotes: ' + err.message;
        document.getElementById('error-message').classList.remove('hidden');
      }
    });

    // When quote selected → store full data + show form
    quoteSelect.addEventListener('change', () => {
      const selected = quoteSelect.options[quoteSelect.selectedIndex];
      if (!selected.value) {
        invoiceForm.classList.add('hidden');
        selectedQuoteData = null;
        return;
      }

      // Parse the full quote data from dataset
      selectedQuoteData = JSON.parse(selected.dataset.fullQuote);

      document.getElementById('inv-address').textContent = selected.dataset.address || '—';
      document.getElementById('inv-client').textContent = selected.dataset.client || '—';
      document.getElementById('inv-total').textContent = '$' + selected.dataset.total;

      invoiceForm.classList.remove('hidden');
    });

    // Generate Invoice – send full quote snapshot to backend
    generateBtn.addEventListener('click', async () => {
      if (!currentUser) {
        alert('You must be signed in to create an invoice.');
        window.location.href = 'login.html';
        return;
      }

      const quoteId = quoteSelect.value;
      if (!quoteId) return alert('Please select a quote first');

      if (!selectedQuoteData) {
        return alert('Selected quote data not loaded. Please try again.');
      }

      const invoiceData = {
        quoteId,
        invoiceNumber: document.getElementById('inv-number').value.trim() || undefined,
        issueDate: document.getElementById('issue-date').value,
        dueDate: document.getElementById('due-date').value,
        paymentTerms: document.getElementById('payment-terms').value,
        notes: document.getElementById('inv-notes').value.trim(),
        totalInclGst: parseFloat(document.getElementById('inv-total').textContent.replace(/[$,]/g, '')) || 0,
        
        // Attach full quote snapshot (this is the key change)
        quoteSnapshot: selectedQuoteData
      };

      try {
        const token = await currentUser.getIdToken();

        const res = await fetch(`${WORKER_URL}/api/invoices`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(invoiceData)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(err.error || 'Failed to create invoice');
        }

        const { invoiceId, invoice } = await res.json();

        // Show success
        document.getElementById('invoice-link-text').textContent = 
          `Invoice created! View it here: ${window.location.origin}/invoice.html?inv=${invoiceId}`;

        document.getElementById('view-invoice-btn').href = 
          `invoice.html?inv=${invoiceId}`;

        document.getElementById('success-message').classList.remove('hidden');
        document.getElementById('invoice-form').classList.add('hidden');

        alert(`Invoice #${invoice.data.invoiceNumber} created successfully!`);

      } catch (err) {
        alert('Error creating invoice: ' + err.message);
        console.error(err);
      }
    });
  </script>
</body>
</html>