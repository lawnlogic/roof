<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Create Invoice • Deep Edge</title>
  <link rel="stylesheet" href="styles.css">
  <script src="header.js" defer></script>
</head>
<body>
  <div class="container" style="max-width: 640px;">
    <h2>Create Invoice</h2>
    <p style="color:#aaa; margin: -8px 0 24px 0;">
      Create invoice from existing quote
    </p>

    <!-- Quote Selection -->
    <div class="input-group">
      <label for="quote-select">Select Quote to Invoice</label>
      <select id="quote-select">
        <option value="">-- Choose a quote without invoice --</option>
      </select>
    </div>

    <!-- Invoice Details Form (hidden until quote selected) -->
    <div id="invoice-form" class="hidden">
      <div class="pricing-box" style="margin: 24px 0;">
        <div class="pricing-row">
          <span>Job Address:</span>
          <strong id="inv-address"></strong>
        </div>
        <div class="pricing-row">
          <span>Client:</span>
          <strong id="inv-client"></strong>
        </div>
        <div class="pricing-row">
          <span>Quote Amount (incl GST):</span>
          <strong id="inv-total"></strong>
        </div>
      </div>

      <!-- Invoice Specific Fields -->
      <div class="input-group">
        <label for="inv-number">Invoice Number</label>
        <input type="text" id="inv-number" placeholder="INV-2025-001" />
      </div>

      <div class="input-group">
        <label for="issue-date">Issue Date</label>
        <input type="date" id="issue-date" value="" />
      </div>

      <div class="input-group">
        <label for="due-date">Due Date</label>
        <input type="date" id="due-date" value="" />
      </div>

      <div class="input-group">
        <label for="payment-terms">Payment Terms</label>
        <select id="payment-terms">
          <option value="7">7 Days</option>
          <option value="14" selected>14 Days</option>
          <option value="20th-next">20th of following month</option>
          <option value="custom">Custom</option>
        </select>
      </div>

      <div class="input-group">
        <label for="inv-notes">Notes / Payment Instructions</label>
        <textarea id="inv-notes" rows="4" placeholder="Bank account: 02-1234-5678901-00&#10;Please pay by internet banking. Thank you!"></textarea>
      </div>

      <button id="generate-invoice-btn" class="action-button" style="margin-top: 24px; width:100%;">
        Generate Invoice
      </button>
    </div>

    <div id="success-message" class="hidden" style="margin-top:32px; padding:20px; background:#1e3a2e; border-radius:12px; text-align:center;">
      <h3 style="margin:0 0 12px 0; color:#8B5CF6;">Invoice Created!</h3>
      <p id="invoice-link-text"></p>
      <a id="view-invoice-btn" class="quote-link-btn" style="display:inline-block; margin-top:16px;" target="_blank">View Invoice</a>
    </div>

    <div id="error-message" class="error hidden" style="margin-top:24px;"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAzS6a2JbgFxSJLPi2-sWyflOfrE7jd73g",
      authDomain: "deep-edge-cc5bd.firebaseapp.com",
      projectId: "deep-edge-cc5bd",
      storageBucket: "deep-edge-cc5bd.firebasestorage.app",
      messagingSenderId: "23198790796",
      appId: "1:23198790796:web:616de764b8a8db2ae1f7a9"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const WORKER_URL = "https://firebase-protected-backend.jamesisarad.workers.dev";

    // ── Declare urlParams ONLY ONCE here ────────────────────────────────
    const urlParams = new URLSearchParams(window.location.search);
    const jobId = urlParams.get('jobId');
    // We can access quoteId later inside the callback
    const preselectedQuoteId = urlParams.get('quoteId');  // safe to declare here

    const quoteSelect = document.getElementById('quote-select');
    const invoiceForm = document.getElementById('invoice-form');
    const generateBtn = document.getElementById('generate-invoice-btn');

    // Pre-fill dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('issue-date').value = today;
    const due = new Date();
    due.setDate(due.getDate() + 14);
    document.getElementById('due-date').value = due.toISOString().split('T')[0];

    let currentUser = null;
    let selectedQuoteFull = null;

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        window.location.href = 'login.html';
        return;
      }

      if (!jobId) {
        document.getElementById('error-message').textContent = 'No job selected. Please come from a job card.';
        document.getElementById('error-message').classList.remove('hidden');
        return;
      }

      const token = await user.getIdToken();

      try {
        const jobRes = await fetch(`${WORKER_URL}/api/jobs/${jobId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!jobRes.ok) throw new Error('Failed to load job details');

        const job = await jobRes.json();
        const quotes = job.quotes || [];

        if (quotes.length === 0) {
          document.getElementById('error-message').textContent = 'No quotes found for this job yet.';
          document.getElementById('error-message').classList.remove('hidden');
          return;
        }

        // Clear any old options
        quoteSelect.innerHTML = '<option value="">-- Choose a quote without invoice --</option>';

        quotes.forEach(q => {
          const option = document.createElement('option');
          option.value = q.id;
          const dateStr = new Date(q.date || q.createdAt || Date.now()).toLocaleDateString('en-NZ', {
            day: 'numeric', month: 'short', year: 'numeric'
          });
          const amount = (q.totalInclGst || q.total || 0).toFixed(2);
          option.textContent = `${q.number || 'Quote'} – $${amount} (${dateStr})`;
          option.dataset.address = job.address || '';
          option.dataset.client = job.client 
            ? `${job.client.firstName || ''} ${job.client.lastName || ''}`.trim()
            : '';
          option.dataset.total = amount;
          option.dataset.fullQuote = JSON.stringify(q);
          quoteSelect.appendChild(option);
        });

        // ── Now pre-select the quote if ?quoteId=... was in the URL ────────
        if (preselectedQuoteId) {
          const matchingOption = Array.from(quoteSelect.options).find(
            opt => opt.value === preselectedQuoteId
          );
          if (matchingOption) {
            quoteSelect.value = preselectedQuoteId;
            quoteSelect.dispatchEvent(new Event('change'));  // trigger the form to show
          } else {
            console.warn(`Quote ID ${preselectedQuoteId} not found among available quotes`);
          }
        }

      } catch (err) {
        document.getElementById('error-message').textContent = 'Error loading job quotes: ' + err.message;
        document.getElementById('error-message').classList.remove('hidden');
      }
    });

    quoteSelect.addEventListener('change', () => {
      const opt = quoteSelect.options[quoteSelect.selectedIndex];
      if (!opt.value) {
        invoiceForm.classList.add('hidden');
        selectedQuoteFull = null;
        return;
      }

      document.getElementById('inv-address').textContent = opt.dataset.address || '—';
      document.getElementById('inv-client').textContent = opt.dataset.client || '—';
      document.getElementById('inv-total').textContent = '$' + (opt.dataset.total || '0.00');

      try {
        selectedQuoteFull = JSON.parse(opt.dataset.fullQuote || '{}');
      } catch {
        selectedQuoteFull = { id: opt.value };
      }

      invoiceForm.classList.remove('hidden');
    });

    generateBtn.addEventListener('click', async () => {
      if (!currentUser) {
        alert('You must be signed in to create an invoice.');
        window.location.href = 'login.html';
        return;
      }

      const quoteId = quoteSelect.value;
      if (!quoteId) return alert('Please select a quote first');

      if (!selectedQuoteFull) {
        return alert('Selected quote data not loaded. Please try again.');
      }

      const invoiceData = {
        quoteId,
        jobId: jobId,
        invoiceNumber: document.getElementById('inv-number').value.trim() || undefined,
        issueDate: document.getElementById('issue-date').value,
        dueDate: document.getElementById('due-date').value,
        paymentTerms: document.getElementById('payment-terms').value,
        notes: document.getElementById('inv-notes').value.trim(),
        totalInclGst: parseFloat(document.getElementById('inv-total').textContent.replace(/[$,]/g, '')) || 0,
        quoteSnapshot: selectedQuoteFull
      };

      try {
        const token = await currentUser.getIdToken();

        const res = await fetch(`${WORKER_URL}/api/invoices`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(invoiceData)
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'Unknown error' }));
          throw new Error(err.error || 'Failed to create invoice');
        }

        const responseData = await res.json();
        const invoiceId = responseData.invoiceId; // assuming backend returns this

        // Show success UI instead of immediate redirect (better UX)
        document.getElementById('invoice-link-text').textContent = 
          `Invoice created! View it here: ${window.location.origin}/invoice.html?inv=${invoiceId}`;

        document.getElementById('view-invoice-btn').href = 
          `invoice.html?inv=${invoiceId}`;

        document.getElementById('success-message').classList.remove('hidden');
        document.getElementById('invoice-form').classList.add('hidden');

        alert(`Invoice created successfully!`);

        // After creation: check localStorage for pending send preference
        try {
          const pendingRaw = localStorage.getItem('pendingInvoiceSend');
          if (pendingRaw) {
            const pending = JSON.parse(pendingRaw);
            // Basic validation: ensure jobId/quoteId match (if provided)
            if (!pending.jobId || String(pending.jobId) === String(jobId)) {
              const method = pending.method;
              const token2 = await currentUser.getIdToken();
              if (method === 'email') {
                try {
                  const sendRes = await fetch(`${WORKER_URL}/api/invoices/${invoiceId}/send-email`, {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token2}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  if (!sendRes.ok) {
                    const txt = await sendRes.text().catch(() => '');
                    console.warn('Invoice email send failed', txt || sendRes.status);
                    alert('Invoice created but automatic email failed to send.');
                  } else {
                    alert('Invoice email sent successfully');
                  }
                } catch (e) {
                  console.error('Invoice email send error', e);
                }
              } else if (method === 'sms') {
                try {
                  // fetch job to get client phone
                  const jobRes2 = await fetch(`${WORKER_URL}/api/jobs/${jobId}`, { headers: { 'Authorization': `Bearer ${token2}` } });
                  let jobData = null;
                  if (jobRes2.ok) jobData = await jobRes2.json();
                  const clientPhone = jobData?.client?.phone || jobData?.client?.mobile || jobData?.client?.phoneNumber;
                  if (!clientPhone) {
                    alert('Invoice created but client phone not found for SMS');
                  } else {
                    const publicLink = `${window.location.origin}/roof/invoice.html?inv=${invoiceId}`;
                    const clientName = (jobData?.client?.firstName || jobData?.client?.name || 'Customer') + (jobData?.client?.lastName ? ` ${jobData.client.lastName}` : '');
                    const amountStr = invoiceData && invoiceData.totalInclGst ? `$${Number(invoiceData.totalInclGst).toFixed(2)}` : (invoiceData && invoiceData.total ? `$${Number(invoiceData.total).toFixed(2)}` : '$0.00');
                    let vendorName = 'Company';
                    let vendorNumber = '';
                    try {
                      const profRes = await fetch(`${WORKER_URL}/api/user/profile`, { headers: { 'Authorization': `Bearer ${token2}` } });
                      if (profRes.ok) {
                        const pj = await profRes.json();
                        vendorName = pj.profile?.companyName || vendorName;
                        vendorNumber = pj.profile?.phone || vendorNumber;
                      }
                    } catch (e) { /* ignore profile fetch errors */ }

                    const message = window.buildMessageFromTemplate('invoice_sent', { clientName, invoiceUrl: publicLink, amount: amountStr, vendorName, vendorNumber });
                    window.showSmsModal(clientName, clientPhone, message, { invoiceId, template: 'invoice_sent', vars: { clientName, invoiceUrl: publicLink, amount: amountStr, vendorName, vendorNumber } });
                  }
                } catch (e) {
                  console.error('Invoice SMS send error', e);
                }
              } else if (method === 'clipboard') {
                try {
                  const link = `${window.location.origin}/roof/invoice.html?inv=${invoiceId}`;
                  await navigator.clipboard.writeText(link);
                  alert('Invoice link copied to clipboard');
                } catch (e) {
                  console.warn('Clipboard copy failed', e);
                }
              }
            }
            // Clear pending preference regardless
            try { localStorage.removeItem('pendingInvoiceSend'); } catch (e) {}
          }
        } catch (e) {
          console.warn('Error handling pendingInvoiceSend', e);
        }

        // Redirect back to jobs list with jobId param
        setTimeout(() => {
          window.location.href = `jobs.html?jobId=${jobId}`;
        }, 1800);   // give user ~1.8 seconds to see the success message

      } catch (err) {
        alert('Error creating invoice: ' + err.message);
        console.error(err);
      }
    });
  </script>
</body>
</html>