<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jobs • Deep Edge (Dynamic Job Flow - Light Mode)</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="header.js" defer></script>
  
  <style>
    :root {
      --bg: #f8f9fc;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --accent: #7c3aed;
      --green: #10b981;
      --green-dark: #059669;
      --yellow: #d97706;
      --blue: #2563eb;
      --red: #dc2626;
      --border: #e5e7eb;
      --radius: 14px;
      --shadow: 0 4px 20px rgba(0,0,0,0.08);
      --modal-bg: rgba(0,0,0,0.65);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Manrope', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 20px 16px;
      line-height: 1.45;
    }

    .container { max-width: 960px; margin: 0 auto; }

    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        margin-top: 60px;
        flex-wrap: wrap;
        gap: 16px;
    }

    h1 { font-size: 2.25rem; font-weight: 800; color: var(--accent); letter-spacing: -0.5px; }

    .btn-new {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.98rem;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(124,58,237,0.2);
    }

    .btn-new:hover { background: #6d28d9; transform: translateY(-1px); }

    .job-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 22px;
      margin-bottom: 32px;
      position: relative;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .job-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 16px 40px rgba(124,58,237,0.15);
    }

    .job-address {
      font-size: 1.48rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 6px;
    }

    .job-client {
      font-size: 1.08rem;
      color: var(--muted);
      margin-bottom: 14px;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px 24px;
      margin-bottom: 16px;
      font-size: 0.94rem;
      color: var(--muted);
    }

    .status-badge {
      padding: 6px 14px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.88rem;
    }

    .status-created   { background: #f3f4f6; color: #4b5563; }
    .status-quoted    { background: #ede9fe; color: #6d28d9; }
    .status-won       { background: #ecfdf5; color: #059669; }
    .status-progress  { background: #fffbeb; color: #d97706; }
    .status-completed { background: #f0fdf4; color: #059669; }
    .status-invoiced  { background: #eff6ff; color: #2563eb; }
    .status-paid      { background: #f0fdf4; color: #059669; }

    .last-activity { 
      font-style: normal; 
      color: #4b5563; 
      font-weight: 500;
    }

    .primary-action {
      display: block;
      width: 100%;
      max-width: 400px;
      margin: 24px auto;
      padding: 16px 20px;
      background: var(--green);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1.14rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.25s;
      box-shadow: 0 5px 16px rgba(16,185,129,0.25);
    }

    .primary-action:hover {
      background: var(--green-dark);
      transform: translateY(-2px);
    }

    .overflow { 
      position: absolute; 
      top: 20px; 
      right: 20px; 
      font-size: 1.9rem; 
      color: var(--muted); 
      cursor: pointer; 
      user-select: none; 
      z-index: 5;
    }

    .menu {
      position: absolute;
      top: 50px;
      right: 0;
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      min-width: 240px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.15);
      z-index: 10;
      display: none;
      overflow: hidden;
    }

    .menu.show { display: block; }

    .menu-section { padding: 6px 0; }

    .menu-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background 0.15s;
      color: var(--text);
      font-size: 0.95rem;
    }

    .menu-item:hover { background: #f3f4f6; }

    .menu-danger {
      color: var(--red);
      border-top: 1px solid var(--border);
    }

    .menu-danger:hover { background: #fee2e2; }

    .progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      margin: 18px 0 22px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      width: 0;
      transition: width 0.6s ease;
    }

    .notes-preview {
      margin-top: 16px;
      padding: 12px;
      background: #f9fafb;
      border-radius: 8px;
      font-size: 0.92rem;
      color: #4b5563;
      line-height: 1.4;
      cursor: pointer;
      border: 1px solid #e5e7eb;
    }

    .notes-preview:hover { background: #f3f4f6; }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--modal-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s;
    }

    .modal-overlay.active {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: white;
      border-radius: 16px;
      width: 90%;
      max-width: 420px;
      padding: 28px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.25);
      transform: translateY(30px);
      transition: transform 0.3s;
    }

    .modal-overlay.active .modal-content {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 1.4rem;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--text);
    }

    .modal-select, .modal-input {
      width: 100%;
      padding: 12px 16px;
      margin-bottom: 16px;
      border: 1px solid #d1d5db;
      border-radius: 10px;
      font-size: 1rem;
      background: #f9fafb;
    }

    .modal-buttons {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn-modal {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      border: none;
    }

    .btn-cancel {
      background: #e5e7eb;
      color: #374151;
    }

    .btn-primary-modal {
      background: var(--green);
      color: white;
    }

    .btn-send {
      background: var(--accent);
      color: white;
      flex: 1;
    }

    .send-options {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    @media (max-width: 500px) {
      .primary-action { font-size: 1.04rem; padding: 14px 18px; }
      .job-address { font-size: 1.32rem; }
      .modal-content { padding: 24px; }
      .menu { min-width: 200px; right: 10px; }
    }

    /* New styles for added elements */
    h2 { font-size: 1.75rem; font-weight: 700; margin-bottom: 20px; color: var(--text); }

    .today-previews {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 48px;
    }

    .mini-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 18px 22px;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      width: 100%;
      max-width: 960px;
      margin: 0 auto;
    }

    .mini-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 24px rgba(124,58,237,0.1);
    }

    .mini-address {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 4px;
    }

    .mini-client {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .mini-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.8rem;
      color: var(--muted);
    }

    .mini-status {
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 0.75rem;
    }

    .calendar {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 48px;
      box-shadow: var(--shadow);
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 8px;
    }

    .calendar-day {
      padding: 12px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 0.9rem;
    }

    .calendar-day.header {
      font-weight: 600;
      background: #f3f4f6;
    }

    .calendar-amount {
      display: block;
      margin-top: 4px;
      color: var(--green);
      font-weight: 600;
    }

    .all-jobs {
      margin-bottom: 48px;
    }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1>Your Jobs</h1>
    <button class="btn-new">+ New Job</button>
  </div>

  <h2>Today</h2>
  <div class="today-previews">
    <div class="mini-card">
      <div class="mini-address">40 Griffen Park Road, Mount Roskill</div>
      <div class="mini-meta">
        <span class="mini-status status-progress">In Progress</span>
        <span>$85 due • 9:00 AM</span>
      </div>
    </div>
    <div class="mini-card">
      <div class="mini-address">15 Oak Street, Epsom</div>
      <div class="mini-meta">
        <span class="mini-status status-won">Job Won</span>
        <span>$120 due • 11:30 AM</span>
      </div>
    </div>
    <div class="mini-card">
      <div class="mini-address">22 Pine Avenue, Remuera</div>
      <div class="mini-meta">
        <span class="mini-status status-completed">Completed</span>
        <span>$95 due • 2:00 PM</span>
      </div>
    </div>
  </div>

  <h2>Calendar</h2>
  <div class="calendar">
    <div class="calendar-grid">
      <div class="calendar-day header">Sun</div>
      <div class="calendar-day header">Mon</div>
      <div class="calendar-day header">Tue</div>
      <div class="calendar-day header">Wed</div>
      <div class="calendar-day header">Thu</div>
      <div class="calendar-day header">Fri</div>
      <div class="calendar-day header">Sat</div>
      <!-- ... calendar content truncated in original ... -->
    </div>
  </div>

  <h2>All Jobs</h2>
  <div class="all-jobs" id="jobs-container">
    <!-- Dynamic jobs will be inserted here -->
  </div>
</div>

<div id="modalOverlay" class="modal-overlay">
  <div class="modal-content" id="modalContent"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAzS6a2JbgFxSJLPi2-sWyflOfrE7jd73g",
  authDomain: "deep-edge-cc5bd.firebaseapp.com",
  projectId: "deep-edge-cc5bd",
  storageBucket: "deep-edge-cc5bd.firebasestorage.app",
  messagingSenderId: "23198790796",
  appId: "1:23198790796:web:616de764b8a8db2ae1f7a9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

const WORKER_URL = "https://firebase-protected-backend.jamesisarad.workers.dev";

// ── Updated STAGES with menuItems ───────────────────────────────────────
const STAGES = [
  {
    id: 'quoted',
    label: 'Quote Created',
    color: 'status-created',
    progress: 14.29,
    primary: 'Send Quote',
    lastActivity: 'Quote created',
    menuItems: [
      { text: 'Edit Quote',   action: 'edit-quote',   danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Delete Quote', action: 'delete-quote', danger: true  }
    ]
  },
  {
    id: 'quoteSent',
    label: 'Quote Sent',
    color: 'status-quoted',
    progress: 28.57,
    primary: 'Schedule Service',
    lastActivity: 'Quote sent to client',
    menuItems: [
      { text: 'Resend Quote',   action: 'resend-quote',   danger: false },
      { text: 'Send Reminder',  action: 'send-reminder',  danger: false },
      { text: 'Edit Quote',     action: 'edit-quote',     danger: false },
      { text: 'Change Price',   action: 'change-price',   danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Cancel Job',     action: 'cancel-job',     danger: true  }
    ]
  },
  {
    id: 'won',
    label: 'Job Won',
    color: 'status-won',
    progress: 42.86,
    primary: 'Start Job',
    lastActivity: 'Job accepted by client',
    menuItems: [
      { text: 'Schedule Visit',   action: 'schedule-visit', danger: false },
      { text: 'Change Frequency', action: 'change-freq',    danger: false },
      { text: 'Adjust Price',     action: 'adjust-price',   danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Cancel Service',   action: 'cancel-service', danger: true  }
    ]
  },
  {
    id: 'progress',
    label: 'In Progress',
    color: 'status-progress',
    progress: 57.14,
    primary: 'Complete Job',
    lastActivity: 'Service started on site',
    menuItems: [
      { text: 'Add Photo',        action: 'add-photo',      danger: false },
      { text: 'Skip Visit',       action: 'skip-visit',     danger: false },
      { text: 'Adjust Price',     action: 'adjust-price',   danger: false },
      { text: 'Change Frequency', action: 'change-freq',    danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Cancel Service',   action: 'cancel-service', danger: true  }
    ]
  },
  {
    id: 'completed',
    label: 'Completed',
    color: 'status-completed',
    progress: 71.43,
    primary: 'Create Invoice',
    lastActivity: 'Job completed',
    menuItems: [
      { text: 'Adjust Final Price', action: 'adjust-final-price', danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Reopen Job',       action: 'reopen-job',       danger: true  }
    ]
  },
  {
    id: 'invoiced',
    label: 'Invoiced',
    color: 'status-invoiced',
    progress: 85.71,
    primary: 'Mark Paid',
    lastActivity: 'Invoice sent',
    menuItems: [
      { text: 'Send Reminder', action: 'send-reminder', danger: false },
      { text: 'View Invoice',  action: 'view-invoice',  danger: false },
      { text: 'Edit Invoice',  action: 'edit-invoice',  danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Void Invoice',  action: 'void-invoice',  danger: true  }
    ]
  },
  {
    id: 'paid',
    label: 'Paid ✓',
    color: 'status-paid',
    progress: 100,
    primary: 'Schedule Next Visit',
    lastActivity: 'Payment received',
    menuItems: [
      { text: 'Send Receipt',  action: 'send-receipt',  danger: false },
      { text: 'View History',  action: 'view-history',  danger: false },
      { text: 'View Details', action: 'view-details', danger: false },
      { text: 'Archive Client', action: 'archive-client', danger: true  }
    ]
  }
];

// ── mockQuotes (kept as-is for invoice modal) ──────────────────────────────
const mockQuotes = [
  { id: 'Q-1021', date: '2026-01-10', total: 285.50 },
  { id: 'Q-1018', date: '2025-12-22', total: 260.00 },
  { id: 'Q-1012', date: '2025-11-30', total: 240.75 }
];

// ── Updated updateCard that uses menuItems ────────────────────────────────
function updateCard(card) {
  const stage = card.dataset.stage;
  const config = STAGES.find(s => s.id === stage) || STAGES[0];

  // Update visible elements
  const badge = card.querySelector('.status-badge');
  if (badge) {
    badge.textContent = config.label;
    badge.className = `status-badge ${config.color}`;
  }

  const lastActivity = card.querySelector('.last-activity');
  if (lastActivity) {
    lastActivity.textContent = `Last activity: ${config.lastActivity}`;
  }

  const progressFill = card.querySelector('.progress-fill');
  if (progressFill) {
    progressFill.style.width = `${config.progress}%`;
  }

  const primaryBtn = card.querySelector('.primary-action');
  if (primaryBtn) {
    primaryBtn.textContent = config.primary;
  }

  // Build dynamic menu
  const menu = card.querySelector('.menu');
  if (!menu) return;
  menu.innerHTML = '';

  const section = document.createElement('div');
  section.className = 'menu-section';

  config.menuItems.forEach(item => {
    const div = document.createElement('div');
    div.className = 'menu-item';
    if (item.danger) div.classList.add('menu-danger');
    div.textContent = item.text;
    div.dataset.action = item.action;
    section.appendChild(div);
  });

  menu.appendChild(section);
}

function showModal(contentHTML) {
  const overlay = document.getElementById('modalOverlay');
  const content = document.getElementById('modalContent');
  content.innerHTML = contentHTML;
  overlay.classList.add('active');
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('active');
}

function advanceStage(card) {
  const current = card.dataset.stage;
  const idx = STAGES.findIndex(s => s.id === current);
  const nextIdx = (idx + 1) % STAGES.length;
  card.dataset.stage = STAGES[nextIdx].id;

  card.style.opacity = '0.65';
  card.style.transform = 'scale(0.98)';
  setTimeout(() => {
    updateCard(card);
    card.style.opacity = '1';
    card.style.transform = 'scale(1)';
  }, 220);
}

function getPrimaryActionText(stage) {
  const map = {
    quoted:   "Send Quote",
    quoteSent:    "Schedule Service",
    won:       "Start Job",
    progress:  "Complete Job",
    completed: "Create Invoice",
    invoiced:  "Mark Paid",
    paid:      "Schedule Next Visit"
  };
  return map[stage] || "Next Step";
}

// ── Main render function ───────────────────────────────────────
async function loadAndRenderJobs() {
  const container = document.getElementById("jobs-container");
  if (!container) return;
  container.innerHTML = '<p style="text-align:center; color:#6b7280; padding:40px;">Loading jobs...</p>';

  try {
    const user = auth.currentUser;
    if (!user) throw new Error("Not signed in. Please log in first.");
    const token = await user.getIdToken(true);

    const res = await fetch(`${WORKER_URL}/api/jobs`, {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    });

    if (!res.ok) {
      const errText = await res.text().catch(() => "No details");
      throw new Error(`Server error ${res.status} – ${errText}`);
    }

    const data = await res.json();
    const jobs = data.jobs || [];

    if (jobs.length === 0) {
      container.innerHTML = '<p style="text-align:center; color:#6b7280; padding:40px;">No jobs yet.<br>Create your first job!</p>';
      return;
    }

    container.innerHTML = '';

    jobs.forEach(job => {
      // Debug what we have from backend
      console.log('[Job render input]', {
        id: job.id,
        status: job.status,
        hasQuotes: !!job.quotes?.length,
        quoteIds: job.quotes?.map(q => q.id) || []
      });

      let normalizedStatus = job.status?.toLowerCase() || 'created';
      if (normalizedStatus === 'quotesent') normalizedStatus = 'quoted';

      // In loadAndRenderJobs, inside jobs.forEach
      console.log('[Status debug]', { backendStatus: job.status, normalized: job.status });

      const statusInfo = STAGES.find(s => s.id === job.status) 
                      || STAGES.find(s => s.id === job.status.toLowerCase()) 
                      || STAGES[0];

      console.log('[Found stage]', { id: statusInfo.id, label: statusInfo.label, primary: statusInfo.primary });

      let clientName = job.client?.firstName || "Unknown";
      if (job.client?.lastName) {
        clientName += ` ${job.client.lastName.charAt(0).toUpperCase()}.`;
      }

      // Declare recurringBadge BEFORE the template
      let recurringBadge = "";
      if (job.isRecurring && job.recurrence) {
        recurringBadge = `<span style="font-size:0.82rem; background:#dcfce7; color:#166534; padding:3px 10px; border-radius:12px; margin-left:8px;">
          ${job.recurrence.charAt(0).toUpperCase() + job.recurrence.slice(1)}
        </span>`;
      }

      // Always calculate latest quote if exists
      let latestQuote = null;
      if (Array.isArray(job.quotes) && job.quotes.length > 0) {
        latestQuote = job.quotes.reduce((a, b) => 
          new Date(a.date) > new Date(b.date) ? a : b
        );
      }

      const cardHTML = `
        <div class="job-card"
             data-stage="${statusInfo.id || 'created'}"
             data-job-id="${job.id || 'MISSING-ID'}"
             data-quote-id="${latestQuote?.id || ''}">
          <div class="overflow">⋯</div>
          <div class="menu"></div>

          <div class="job-address">
            ${job.address || 'No address'}${recurringBadge}
          </div>
          <div class="job-client">
            ${clientName} • ${job.client?.phone || "No phone"}
          </div>

          <div class="meta">
            <span class="status-badge ${statusInfo.color}">${statusInfo.label}</span>
            <span class="last-activity" title="${job.activityLog?.map(log => log.timestamp + ': ' + log.action).join('\n') || ''}">
              Last activity: ${job.nextAction || "—"}
            </span>
          </div>

          <div class="progress-bar">
            <div class="progress-fill"></div>
          </div>

          <button class="primary-action">${statusInfo.primary}</button>

          <div class="notes-preview">
            <b>NOTES:</b> ${job.jobNotes ? job.jobNotes.substring(0, 120) + (job.jobNotes.length > 120 ? "..." : "") : "No notes added yet"}
          </div>
        </div>
      `;

      container.insertAdjacentHTML("beforeend", cardHTML);
    });

    attachCardEventListeners();

  } catch (err) {
    console.error("Failed to load jobs:", err);
    container.innerHTML = `<p style="text-align:center; color:#dc2626; padding:40px; white-space:pre-wrap;">
      Could not load jobs\n\n${err.message}
    </p>`;
  }
}

function showScheduleModal(card) {
  showModal(`
    <h2 class="modal-title">Schedule Service</h2>
    <label style="display:block; margin-bottom:8px; font-weight:600;">Frequency</label>
    <select class="modal-select" id="frequencySelect">
      <option>One-off</option>
      <option>Weekly</option>
      <option selected>Fortnightly</option>
      <option>Monthly</option>
    </select>
    <label style="display:block; margin:16px 0 8px; font-weight:600;">Start Date</label>
    <input type="date" class="modal-input" id="nextDateInput" value="2026-01-28">
    <div class="modal-buttons">
      <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-modal btn-primary-modal confirm-schedule">Confirm Schedule</button>
    </div>
  `);

  const modal = document.getElementById('modalContent');
  modal.querySelector('.confirm-schedule').addEventListener('click', async () => {
    const frequency = modal.querySelector('#frequencySelect').value;
    const nextDate = modal.querySelector('#nextDateInput').value;

    if (!nextDate) {
      alert("Please select a start date");
      return;
    }

    try {
      const user = auth.currentUser;
      if (!user) throw new Error("Not signed in");

      const token = await user.getIdToken();

      const jobId = card.getAttribute('data-job-id');
      if (!jobId) throw new Error("No job ID on card");

      const patchRes = await fetch(`${WORKER_URL}/api/jobs/${jobId}`, {
        method: 'PATCH',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          isRecurring: frequency !== 'One-off',
          recurrence: frequency !== 'One-off' ? frequency.toLowerCase() : null,
          nextServiceDate: nextDate,
          status: 'won', // or 'progress' — choose your next logical stage
          nextAction: `Next ${frequency} service on ${new Date(nextDate).toLocaleDateString('en-NZ')}`
        })
      });

      if (!patchRes.ok) {
        const err = await patchRes.json().catch(() => ({}));
        throw new Error(err.error || `Update failed (${patchRes.status})`);
      }

      closeModal();

      // Optimistic frontend update
      card.dataset.stage = 'won'; // match the status you set above
      updateCard(card);

      alert("Service scheduled successfully!");

    } catch (err) {
      console.error("Schedule save failed:", err);
      alert("Failed to save schedule:\n" + err.message);
    }
  });
}

function attachCardEventListeners() {
  const cards = document.querySelectorAll('.job-card');

  cards.forEach(card => {
    // 1. Update card visuals (progress, badge, button text, menu items)
    updateCard(card);

    // 2. Primary action button ("Send Quote", "Schedule Service", etc.)
    const primaryBtn = card.querySelector('.primary-action');
    if (primaryBtn) {
      primaryBtn.addEventListener('click', async () => {
        // DEBUG: Log clicked card and attributes
        console.log('Clicked card element:', card.outerHTML.substring(0, 200) + '...');
        console.log('Current attributes:', {
          jobIdAttr: card.getAttribute('data-job-id'),
          quoteIdAttr: card.getAttribute('data-quote-id'),
          stageAttr: card.getAttribute('data-stage')
        });

        const stage = card.getAttribute('data-stage') || 'unknown';
        const jobId = card.getAttribute('data-job-id') || '';
        const quoteIdFromCard = card.getAttribute('data-quote-id') || '';

        console.log('[Primary button clicked]', {
          stage,
          jobId,
          quoteIdFromCard,
          quoteIdType: typeof quoteIdFromCard,
          hasJobId: !!jobId,
          hasQuoteId: !!quoteIdFromCard && quoteIdFromCard.trim() !== ''
        });

        if (stage === 'quoted') {
          // Show send modal
          showModal(`
            <h2 class="modal-title">Send Quote</h2>
            <p style="margin-bottom:20px; color:#4b5563;">Choose how to send the quote to the client:</p>
            <div class="send-options">
              <button class="btn-modal btn-primary-modal btn-send send-email">Email</button>
              <button class="btn-modal btn-primary-modal btn-send send-sms">SMS</button>
              <button class="btn-modal btn-primary-modal btn-send send-clipboard">Copy to Clipboard</button>
            </div>
            <div class="modal-buttons" style="margin-top:24px;">
              <button class="btn-modal btn-cancel" onclick="closeModal()">Cancel</button>
            </div>
          `);

          // Handle clicks inside the modal
          const modalContent = document.getElementById('modalContent');
          modalContent.querySelectorAll('.send-email, .send-sms, .send-clipboard').forEach(btn => {
            btn.addEventListener('click', async () => {
              const isEmail = btn.classList.contains('send-email');
              if (!isEmail) {
                closeModal();
                advanceStage(card);
                return;
              }

              // ── EMAIL SEND ─────────────────────────────────────────────────────
              btn.disabled = true;
              btn.textContent = "Sending...";

              let finalQuoteId = quoteIdFromCard;

              try {
                console.log('[Email send] Starting with quoteId:', finalQuoteId);

                // Fallback: fetch fresh job if quoteId missing from card
                if (!finalQuoteId || finalQuoteId.trim() === '') {
                  console.warn('[Fallback] No quoteId on card → fetching job fresh');
                  const user = auth.currentUser;
                  if (!user) throw new Error("Not signed in");

                  const token = await user.getIdToken();
                  console.log('[Fallback] Fetching job:', jobId);

                  if (!jobId || jobId.trim() === '') {
                    throw new Error("No job ID on card either — cannot proceed");
                  }

                  const jobRes = await fetch(`${WORKER_URL}/api/jobs/${jobId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                  });

                  console.log('[Fallback] Job fetch status:', jobRes.status);

                  if (!jobRes.ok) {
                    const errText = await jobRes.text().catch(() => "");
                    throw new Error(`Job fetch failed: ${jobRes.status} - ${errText}`);
                  }

                  const jobData = await jobRes.json();
                  console.log('[Fallback] Job data received:', jobData);

                  const latestQ = jobData.quotes?.length > 0
                    ? jobData.quotes.reduce((a, b) => new Date(a.date) > new Date(b.date) ? a : b)
                    : null;

                  finalQuoteId = latestQ?.id;
                  if (!finalQuoteId) {
                    throw new Error("No quote found even after fetching job");
                  }
                }

                console.log('[Send] Using final quoteId:', finalQuoteId);

                const user = auth.currentUser;
                const token = await user.getIdToken();

                const sendRes = await fetch(`${WORKER_URL}/api/quotes/${finalQuoteId}/send-email`, {
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                  }
                });

                console.log('[Send email] Response status:', sendRes.status);

                if (!sendRes.ok) {
                  let errMsg = await sendRes.text().catch(() => `HTTP ${sendRes.status}`);
                  throw new Error(errMsg);
                }

                closeModal();
                advanceStage(card);
                alert("Quote email sent successfully!");
                // Optional: refresh to show real backend status
                loadAndRenderJobs();

              } catch (err) {
                console.error('[Email send failed]', err);
                alert("Failed to send email:\n" + err.message);
              } finally {
                btn.disabled = false;
                btn.textContent = "Email";
              }
            });
          });
        } 
        else if (stage === 'quoteSent') {
          showScheduleModal(card);
        } 
        else {
          advanceStage(card);
        }
      });
    }

    // 3. Overflow ⋯ menu toggle
    const overflow = card.querySelector('.overflow');
    const menu = card.querySelector('.menu');
    if (overflow && menu) {
      overflow.addEventListener('click', e => {
        e.stopPropagation();
        document.querySelectorAll('.menu.show').forEach(m => m.classList.remove('show'));
        menu.classList.toggle('show');
      });
    }

    // 4. Menu item clicks (including delete-quote)
    card.querySelectorAll('.menu-item').forEach(item => {
      item.addEventListener('click', async () => {
        const action = item.dataset.action;
        const jobId = card.getAttribute('data-job-id') || '';
        const quoteId = card.getAttribute('data-quote-id') || '';
        const currentMenu = card.querySelector('.menu');

        if (action === 'edit-quote') {
          window.location.href = 'quote.html';
        }
        else if (action === 'view-details') {
          window.location.href = `job.html?id=${jobId}`;
        }
        else if (action === 'delete-quote') {
          if (!confirm("Delete this quote? The job will revert to 'Lead' status.")) return;

          if (!quoteId || quoteId.trim() === '') {
            alert("Cannot delete — no quote is associated with this job card");
            return;
          }

          try {
            const user = auth.currentUser;
            if (!user) throw new Error("Not signed in");

            const token = await user.getIdToken();

            const res = await fetch(`${WORKER_URL}/api/quotes/${quoteId}`, {
              method: 'DELETE',
              headers: { 'Authorization': `Bearer ${token}` }
            });

            if (!res.ok) {
              const errBody = await res.json().catch(() => ({}));
              throw new Error(errBody.error || `Delete failed (${res.status})`);
            }

            card.dataset.stage = 'created';
            updateCard(card);

            if (currentMenu) currentMenu.classList.remove('show');

            alert("Quote deleted successfully");

          } catch (err) {
            console.error("Delete quote failed:", err);
            alert("Failed to delete quote:\n" + err.message);
          }
        }

        if (action === 'schedule-visit') {
          // Close menu immediately
          if (currentMenu) currentMenu.classList.remove('show');

          // Open the same schedule modal
          showScheduleModal(card);
        }

        if (currentMenu) currentMenu.classList.remove('show');
      });
    });
  });

  // Close menus when clicking anywhere outside
  document.addEventListener('click', e => {
    if (!e.target.closest('.overflow') && !e.target.closest('.menu')) {
      document.querySelectorAll('.menu.show').forEach(m => m.classList.remove('show'));
    }
  });
}

// ── Start ───────────────────────────────────────────────────────
document.addEventListener('DOMContentLoaded', () => {
  auth.onAuthStateChanged((user) => {
    if (user) {
      loadAndRenderJobs();
    } else {
      document.getElementById('jobs-container').innerHTML = `
        <p style="text-align:center; padding:60px; color:#6b7280;">
          Please sign in to view your jobs
        </p>
      `;
    }
  });

  document.getElementById('modalOverlay').addEventListener('click', e => {
    if (e.target === e.currentTarget) closeModal();
  });

  const miniStatuses = document.querySelectorAll('.mini-status');
  miniStatuses.forEach(status => {
    const text = status.textContent.toLowerCase().replace(' ', '-');
    status.classList.add(`status-${text}`);
  });
});
</script>
</body>
</html>