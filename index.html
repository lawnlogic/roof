<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Roof Area Calculator</title>
  <link rel="stylesheet" href="styles.css">
  <!-- Leaflet CSS for aerial map -->
  <!-- Replace your current Leaflet loading with this block -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
</head>
<body>
  <div class="container">
    <h2>Roof Area Calculator</h2>
    <div class="input-group">
      <label for="address">NZ Address:</label>
      <input
        type="text"
        id="address"
        placeholder="67 Williamson Avenue, Grey Lynn, Auckland"
      />
    </div>
    <button id="lookup-btn">Calculate Area</button>
    <div id="result" class="result hidden">
      <div id="address-display"></div>
      <div id="area"></div>
      <div id="time"></div>
    </div>
    <div id="error" class="error hidden"></div>

    <!-- NEW: Aerial map will appear here when data is loaded -->
    <div id="aerial-container" class="hidden" style="margin-top: 40px;">
      <h2 style="margin-bottom: 15px;">Aerial View</h2>
      <div id="aerial-map" style="width:100%; height:600px; border:2px solid #ccc; border-radius:8px;"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    const firebaseConfig = {
      apiKey: "AIzaSyAzS6a2JbgFxSJLPi2-sWyflOfrE7jd73g",
      authDomain: "deep-edge-cc5bd.firebaseapp.com",
      projectId: "deep-edge-cc5bd",
      storageBucket: "deep-edge-cc5bd.firebasestorage.app",
      messagingSenderId: "23198790796",
      appId: "1:23198790796:web:616de764b8a8db2ae1f7a9",
      measurementId: "G-GLYGPCHRXM"
    };
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    console.log("Firebase Auth initialized on calculator page");
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log("User is signed in:", user.email);
      } else {
        console.log("No signed-in user");
      }
    });

    const WORKER_URL = "https://firebase-protected-backend.jamesisarad.workers.dev/api/building-area";
    const btn = document.getElementById('lookup-btn');
    const addressInput = document.getElementById('address');
    const resultDiv = document.getElementById('result');
    const errorDiv = document.getElementById('error');
    const addressDisplay = document.getElementById('address-display');
    const areaDisplay = document.getElementById('area');
    const timeDisplay = document.getElementById('time');
    const aerialContainer = document.getElementById('aerial-container');

    let map = null;
    let editableLayers = null;
    let areaOverlay = null;

    function showAerialMap(data) {
      if (!data.aerial || !data.building_geometry) {
        aerialContainer.style.display = 'none';
        return;
      }
      aerialContainer.classList.remove('hidden');

      if (typeof L === 'undefined' || typeof L.Draw === 'undefined') {
        setTimeout(() => showAerialMap(data), 100);
        return;
      }

      if (map) map.remove();

      map = L.map('aerial-map').setView(data.aerial.center, data.aerial.zoom);

      L.tileLayer(data.aerial.tileUrl, {
        attribution: '© LINZ Aerial Imagery',
        maxZoom: 22
      }).addTo(map);

      // Initial non-editable outline
      L.geoJSON(data.building_geometry, {
        style: { color: "#513690", weight: 2, opacity: 0.9, fillOpacity: 0.15 }
      }).addTo(map);

      map.fitBounds(L.geoJSON(data.building_geometry).getBounds().pad(0.3));

      // Add Edit button
      const editBtn = L.control({ position: 'topright' });
      editBtn.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.style.backgroundColor = '#513690';
        div.style.color = 'white';
        div.style.width = '36px';
        div.style.height = '36px';
        div.style.textAlign = 'center';
        div.style.lineHeight = '36px';
        div.style.borderRadius = '4px';
        div.style.cursor = 'pointer';
        div.style.fontWeight = 'bold';
        div.innerHTML = '✏️';
        div.title = 'Edit Roof Outline';
        div.onclick = (e) => {
          L.DomEvent.stopPropagation(e);
          enableRoofEditing(data);
        };
        return div;
      };
      editBtn.addTo(map);
    }

    function enableRoofEditing(data) {
      if (!map || !data.building_geometry) return;

      // Clear everything except base tiles
      map.eachLayer(layer => {
        if (layer._url && layer._url.includes('basemaps.linz.govt.nz')) {
          // Keep tile layer
        } else {
          map.removeLayer(layer);
        }
      });

      // Remove any existing draw control
      if (map.drawControl) {
        map.removeControl(map.drawControl);
      }

      // New editable group
      editableLayers = new L.FeatureGroup();
      map.addLayer(editableLayers);

      // Add the original polygon — this is the ONLY shape
      L.geoJSON(data.building_geometry, {
        style: { color: "#513690", weight: 2, fillOpacity: 0.2 }
      }).eachLayer(layer => editableLayers.addLayer(layer));

      // Create draw control with ZERO drawing tools
      const drawControl = new L.Control.Draw({
        position: 'topleft',
        draw: false, // No drawing at all
        edit: {
          featureGroup: editableLayers,
          edit: true,
          remove: true
        }
      });

      // Store reference so we can remove later
      map.drawControl = drawControl;
      map.addControl(drawControl);

      // Area display
      if (areaOverlay) areaOverlay.remove();
      areaOverlay = L.control({ position: 'bottomleft' });
      areaOverlay.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
        div.style.background = '#513690';
        div.style.padding = '12px 18px';
        div.style.borderRadius = '8px';
        div.style.fontSize = '18px';
        div.style.fontWeight = 'bold';
        div.style.boxShadow = '0 3px 12px rgba(0,0,0,0.3)';
        div.innerHTML = 'Calculating...';
        areaOverlay._div = div;
        return div;
      };
      areaOverlay.addTo(map);

      function updateArea() {
        let total = 0;
        editableLayers.eachLayer(layer => {
          if (layer.getLatLngs) {
            total += L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
          }
        });
        const areaM2 = Math.round(total);
        areaOverlay._div.innerHTML = `<strong>Roof Area:</strong> ${areaM2.toLocaleString()} m²`;
        areaDisplay.textContent = `${areaM2.toLocaleString()} m² (edited)`;
      }

      map.on('draw:edited draw:deleted', updateArea);
      updateArea();
    }

    btn.addEventListener('click', async () => {
      const address = addressInput.value.trim();
      if (!address) {
        showError("Please enter a valid address");
        return;
      }
      hideError();
      resultDiv.classList.add('hidden');
      aerialContainer.classList.add('hidden');
      btn.disabled = true;
      btn.textContent = "Looking up...";
      btn.classList.add('loading');

      try {
        const startTime = performance.now();
        let token = null;
        if (auth.currentUser) {
          token = await auth.currentUser.getIdToken(true);
        }
        const response = await fetch(`${WORKER_URL}?address=${encodeURIComponent(address)}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          }
        });
        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          throw new Error("Invalid response from server");
        }
        const timeTaken = ((performance.now() - startTime) / 1000).toFixed(1);
        if (!response.ok || data.error) {
          throw new Error(data.error || "Service error");
        }
        if (data.building_found === true) {
          addressDisplay.textContent = data.address;
          areaDisplay.textContent = `${data.building_area_m2.toLocaleString()} m²`;
          timeDisplay.textContent = `Found in ${timeTaken} seconds`;
          resultDiv.classList.remove('hidden');
          showAerialMap(data);
        } else {
          showError(data.message || "No building found");
        }
      } catch (err) {
        showError(err.message || "Failed to fetch data");
      } finally {
        btn.disabled = false;
        btn.textContent = "Calculate Area";
        btn.classList.remove('loading');
      }
    });

    addressInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') btn.click();
    });

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.remove('hidden');
    }
    function hideError() {
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';
    }
  </script>
</body>
</html>
