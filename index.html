<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover"/>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <title>Deep Edge - AI Powered Quoting Tool</title>
  <link rel="stylesheet" href="styles.css">
  <script src="header.js" defer></script>
</head>
<body>

<div class="container">

  <div class="hero">
    <h1>New Zealand's AI Powered Quoting Tool to Save your Business Money and Time.</h1>
    <p>Sign up customers from your website and send out quotes from your device in the field in seconds </p>
  </div>

  <div class="image-container">
    <img src="Images/roofmeasuretool.png" alt="My roof area calculator screenshot">
  </div>

  <div class="section-title">
    Everything you need for Instant Quotes and Accurate Measurements for Customers.
    <p class="home-subheader">Use AI to create highly accurate quotes for customers within seconds. Save time and money.</p>
  </div>

  <div class="image-container">
    <img src="Images/roofbasicquote.png" alt="My roof area calculator screenshot">
  </div>

  <div class="section-title">
    Everything you need for Instant Quotes and Accurate Measurements for Customers.
    <p class="home-subheader">Use AI to create highly accurate quotes for customers within seconds. Save time and money.</p>
  </div>

  <div class="image-container">
    <img src="Images/quotewithimage.png" alt="My roof area calculator screenshot">
  </div>

  <div class="section-title">
    Bespoke Software
    <p class="home-subheader">Our software is available to run on any device, create quotes while on the go.</p>
  </div>

  <div class="image-container">
    <img src="Images/Ipadpic2.png" alt="iPad view">
  </div>

  <!-- New random header + home-subheader -->
  <div class="section-title">
    Plans available
    <p class="home-subheader">We cater to all business, no matter the size we have a solution.</p>
  </div>

  <!-- Carousel with the other images -->
  <div class="slideshow-container">
    <div class="slide fade">
      <img src="Images/Light1.png" alt="Light plan" class="carousel-img">
    </div>

    <div class="slide fade">
      <img src="Images/Launch1.png" alt="Launch plan" class="carousel-img">
    </div>

    <div class="slide fade">
      <img src="Images/Performance1.png" alt="Performance plan" class="carousel-img">
    </div>

    <div class="slide fade">
      <img src="Images/Premium1.png" alt="Premium plan" class="carousel-img">
    </div>

    <!-- Navigation arrows -->
    <button class="prev" onclick="plusSlides(-1)">❮</button>
    <button class="next" onclick="plusSlides(1)">❯</button>
  </div>

  <!-- Dots/indicators -->
  <div style="text-align:center; margin: 12px 0;">
    <span class="dot" onclick="currentSlide(1)"></span>
    <span class="dot" onclick="currentSlide(2)"></span>
    <span class="dot" onclick="currentSlide(3)"></span>
    <span class="dot" onclick="currentSlide(4)"></span>
  </div>

  <!-- Contact info -->
  <div class="bottom-bar">
    <div>+64 21 026 53330</div>
    <div><a href="mailto:lawnlogic67@gmail.com">lawnlogic67@gmail.com</a></div>
  </div>

</div>

<!-- Slideshow JavaScript -->
<script>
let slideIndex = 1;
showSlides(slideIndex);

function plusSlides(n) {
  showSlides(slideIndex += n);
}

function currentSlide(n) {
  showSlides(slideIndex = n);
}

function showSlides(n) {
  let i;
  let slides = document.getElementsByClassName("slide");
  let dots = document.getElementsByClassName("dot");
  
  if (n > slides.length) {slideIndex = 1}    
  if (n < 1) {slideIndex = slides.length}
  
  for (i = 0; i < slides.length; i++) {
    slides[i].style.display = "none";  
  }
  
  for (i = 0; i < dots.length; i++) {
    dots[i].className = dots[i].className.replace(" active", "");
  }
  
  slides[slideIndex-1].style.display = "block";  
  if (dots.length > 0) dots[slideIndex-1].className += " active";
}
</script>

<<<<<<< HEAD
=======
      currentLawnArea = Math.max(0, parcelAreaM2 - Math.round(negativeArea));
      console.log(`Parcel area: ${parcelAreaM2} m²`);
      console.log(`Final lawn area: ${currentLawnArea} m²`);
      console.log("=== End Debug ===\n");

      if (areaOverlay && areaOverlay._div) {
        areaOverlay._div.innerHTML = `<strong>Lawn Area:</strong> ${currentLawnArea.toLocaleString()} m²`;
      }
      areaDisplay.textContent = `${currentLawnArea.toLocaleString()} m² (edited)`;
      finalAreaDisplay.textContent = `${currentLawnArea.toLocaleString()} m²`;

      const rate = parseFloat(rateInput.value) || 0;
      const callout = parseFloat(calloutInput.value) || 0;
      const difficulty = parseFloat(difficultySlider.value) || 1.0;
      const catchMulchFee = catchMulchCheckbox.checked ? 40 : 0;
      const hours = parseFloat(estimatedHoursInput.value) || 1;
      const hourlyCost = parseFloat(hourlyRateInput.value) || 0;

      const baseMowing = currentLawnArea * rate;
      const adjustedRevenue = (baseMowing * difficulty) + callout + catchMulchFee;
      const gst = adjustedRevenue * 0.15;
      const totalIncl = adjustedRevenue + gst;
      const estCost = hours * hourlyCost;
      const estProfit = adjustedRevenue - estCost;
      const profitPerHour = hours > 0 ? estProfit / hours : 0;

      document.getElementById('mowing-revenue').textContent = '$' + baseMowing.toFixed(2);
      document.getElementById('total-revenue').textContent = '$' + adjustedRevenue.toFixed(2);
      document.getElementById('gst').textContent = '$' + gst.toFixed(2);
      document.getElementById('total-incl').textContent = '$' + totalIncl.toFixed(2);
      document.getElementById('est-cost').textContent = '$' + estCost.toFixed(2);
      document.getElementById('est-profit').textContent = '$' + estProfit.toFixed(2);
      document.getElementById('profit-hour').textContent = '$' + profitPerHour.toFixed(2);
    }

    function showAerialMap(data) {
      currentData = data;
      if (!data.aerial) {
        aerialContainer.style.display = 'none';
        return;
      }
      aerialContainer.classList.remove('hidden');
      if (map) map.remove();
      map = L.map('aerial-map').setView(data.aerial.center, data.aerial.zoom);

      L.tileLayer(LINZ_AERIAL_URL, {
        attribution: '© <a href="https://www.linz.govt.nz/data/licensing-and-using-data/attributing-linz-data">LINZ</a> Aerial Imagery',
        maxZoom: 24,
        tileSize: 256,
        zoomOffset: 0,
        noWrap: true
      }).addTo(map);

      parcelAreaM2 = data.parcel_area_m2 || 0;
      if (data.parcel_geometry) {
        parcelLayer = L.geoJSON(data.parcel_geometry, {
          style: { color: "#0066ff", weight: 2, fillOpacity: 0 }
        }).addTo(map);
      }

      if (data.parcel_geometry && data.buildings_geometries && data.buildings_geometries.length > 0) {
        try {
          let parcelPoly;
          if (data.parcel_geometry.type === "MultiPolygon") {
            parcelPoly = turf.multiPolygon(data.parcel_geometry.coordinates);
          } else {
            parcelPoly = turf.polygon(data.parcel_geometry.coordinates);
          }
          const clippedBuildings = [];
          data.buildings_geometries.forEach(geom => {
            try {
              if (geom.type === "Polygon" && geom.coordinates && geom.coordinates.length > 0) {
                const ring = geom.coordinates[0];
                if (ring.length >= 4) {
                  const cleaned = [];
                  ring.forEach((p, i) => {
                    const prev = ring[i === 0 ? ring.length - 1 : i - 1];
                    if (i === 0 || p[0] !== prev[0] || p[1] !== prev[1]) {
                      cleaned.push(p);
                    }
                  });
                  if (cleaned.length >= 4) {
                    if (cleaned[0][0] !== cleaned[cleaned.length - 1][0] || cleaned[0][1] !== cleaned[cleaned.length - 1][1]) {
                      cleaned.push(cleaned[0]);
                    }
                    const buildingPoly = turf.polygon([cleaned]);
                    const intersection = turf.intersect(parcelPoly, buildingPoly);
                    if (intersection && intersection.geometry) {
                      clippedBuildings.push(intersection.geometry);
                    }
                  }
                }
              }
            } catch (e) {}
          });
          if (clippedBuildings.length > 0) {
            clippedBuildingsGeoJSON = { type: "FeatureCollection", features: clippedBuildings.map(g => ({ type: "Feature", geometry: g })) };
            clippedBuildingsLayer = L.geoJSON(clippedBuildings, {
              style: { color: "#ff4444", weight: 2, fillColor: "#ff4444", fillOpacity: 0.5 }
            }).addTo(map);
          }
        } catch (e) {
          console.warn('Building clipping failed', e);
        }
      }

      if (parcelLayer) {
        map.fitBounds(parcelLayer.getBounds().pad(0.2));
      }
      pricingBox.classList.remove('hidden');

      const editBtn = L.control({ position: 'topright' });
      editBtn.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
        div.style.backgroundColor = '#ff4444';
        div.style.color = 'white';
        div.style.width = '36px';
        div.style.height = '36px';
        div.style.textAlign = 'center';
        div.style.lineHeight = '36px';
        div.style.borderRadius = '2px';
        div.style.cursor = 'pointer';
        div.style.fontWeight = 'bold';
        div.innerHTML = '✏️';
        div.title = 'Edit Negative Layer (areas to exclude from lawn)';
        div.onclick = (e) => {
          L.DomEvent.stopPropagation(e);
          enableNegativeLayerEditing();
        };
        return div;
      };
      editBtn.addTo(map);
    }

    function enableNegativeLayerEditing() {
      if (!map) return;
      if (clippedBuildingsLayer) {
        map.removeLayer(clippedBuildingsLayer);
        clippedBuildingsLayer = null;
      }
      if (negativeLayer) map.removeLayer(negativeLayer);
      if (areaOverlay) areaOverlay.remove();
      negativeLayer = new L.FeatureGroup();
      map.addLayer(negativeLayer);
      if (clippedBuildingsGeoJSON) {
        L.geoJSON(clippedBuildingsGeoJSON, {
          style: { color: "#ff4444", weight: 2, fillColor: "#ff4444", fillOpacity: 0.6 }
        }).eachLayer(layer => {
          negativeLayer.addLayer(layer);
        });
      }
      const drawControl = new L.Control.Draw({
        draw: {
          polygon: true,
          rectangle: false,
          circle: false,
          circlemarker: false,
          marker: false,
          polyline: false
        },
        edit: {
          featureGroup: negativeLayer,
          edit: true,
          remove: true
        }
      });
      map.addControl(drawControl);
      map.on('draw:created', function (e) {
        const layer = e.layer;
        negativeLayer.addLayer(layer);
        updateLawnArea();
      });
      areaOverlay = L.control({ position: 'bottomleft' });
      areaOverlay.onAdd = function () {
        const div = L.DomUtil.create('div', 'leaflet-control leaflet-bar');
        div.style.background = 'rgba(255,255,255,0.95)';
        div.style.padding = '12px 18px';
        div.style.borderRadius = '8px';
        div.style.fontSize = '18px';
        div.style.fontWeight = 'bold';
        div.style.boxShadow = '0 3px 12px rgba(0,0,0,0.3)';
        div.innerHTML = 'Calculating...';
        areaOverlay._div = div;
        return div;
      };
      areaOverlay.addTo(map);

      map.on('draw:edited draw:deleted draw:created', updateLawnArea);
      updateLawnArea();
    }

    btn.addEventListener('click', async () => {
      const address = addressInput.value.trim();
      if (!address) {
        showError("Please enter a valid address");
        return;
      }
      hideError();
      resultDiv.classList.add('hidden');
      aerialContainer.classList.add('hidden');
      pricingBox.classList.add('hidden');
      btn.disabled = true;
      btn.textContent = "Looking up...";
      btn.classList.add('loading');
      try {
        const startTime = performance.now();
        let token = null;
        if (auth.currentUser) {
          token = await auth.currentUser.getIdToken(true);
        }
        const response = await fetch(`${WORKER_URL}/api/building-area?address=${encodeURIComponent(address)}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            ...(token ? { 'Authorization': `Bearer ${token}` } : {})
          }
        });
        const text = await response.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          throw new Error("Invalid response from server");
        }
        const timeTaken = ((performance.now() - startTime) / 1000).toFixed(1);
        if (!response.ok || data.error) {
          throw new Error(data.error || "Service error");
        }
        addressDisplay.textContent = data.address;
        areaDisplay.textContent = `${data.estimated_lawn_area_m2?.toLocaleString() || 'Calculating...'} m²`;
        timeDisplay.textContent = `Found in ${timeTaken} seconds`;
        resultDiv.classList.remove('hidden');
        showAerialMap(data);
      } catch (err) {
        showError(err.message || "Failed to fetch data");
      } finally {
        btn.disabled = false;
        btn.textContent = "Calculate Lawn Area";
        btn.classList.remove('loading');
      }
    });

    addressInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') btn.click();
    });

    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.remove('hidden');
    }

    function hideError() {
      errorDiv.classList.add('hidden');
      errorDiv.textContent = '';
    }

    // Quote Link Generation - NOW WITH COMPANY PROFILE
    document.getElementById('generate-pdf-btn').addEventListener('click', async () => {
      if (!currentData || currentLawnArea === 0) {
        alert('Please load an address and measure the lawn area first.');
        return;
      }
      if (!auth.currentUser) {
        alert('Please sign in to save quotes');
        window.location.href = 'login.html';
        return;
      }

      const token = await auth.currentUser.getIdToken();

      // === FETCH USER PROFILE ===
      let companyProfile = {};
      try {
        const profileRes = await fetch(`${WORKER_URL}/api/user/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (profileRes.ok) {
          const { profile } = await profileRes.json();
          companyProfile = {
            companyName: profile.companyName || 'Deep Edge',
            nzbn: profile.nzbn || '',
            phone: profile.phone || '',
            gstNumber: profile.gstNumber || '',
            email: profile.email || '',
            logoUrl: profile.logoUrl || ''
          };
        }
      } catch (e) {
        console.warn('Could not fetch company profile for quote', e);
      }

      const negativeGeoJSON = negativeLayer ? negativeLayer.toGeoJSON() : { type: "FeatureCollection", features: [] };

      const quoteData = {
        address: addressDisplay.textContent,
        lawnAreaM2: currentLawnArea,
        ratePerM2: parseFloat(rateInput.value) || 0,
        calloutFee: parseFloat(document.getElementById('callout-input').value) || 0,
        difficultyMultiplier: parseFloat(difficultySlider.value),
        catchAndMulch: catchMulchCheckbox.checked,
        estimatedHours: parseFloat(document.getElementById('estimated-hours').value) || 1,
        hourlyCost: parseFloat(document.getElementById('hourly-rate').value) || 0,
        client: {
          firstName: document.getElementById('client-first').value.trim(),
          lastName: document.getElementById('client-last').value.trim(),
          email: document.getElementById('client-email').value.trim(),
          phone: document.getElementById('client-phone').value.trim()
        },
        company: companyProfile, // ← NEW: Full company details from profile
        mapState: {
          center: map.getCenter(),
          zoom: map.getZoom(),
          parcelGeometry: currentData.parcel_geometry,
          buildingsGeoJSON: clippedBuildingsGeoJSON,
          negativeGeoJSON: negativeGeoJSON
        },
        generatedAt: new Date().toISOString()
      };

      try {
        console.log('Saving quote with company details...', quoteData);
        const res = await fetch(`${WORKER_URL}/api/quotes`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(quoteData)
        });

        if (!res.ok) {
          const errText = await res.text();
          throw new Error(errText || 'Failed to save quote');
        }

        const { quoteId } = await res.json();
        const publicLink = `${window.location.origin}/roof/quote.html?quote=${quoteId}`;

        document.getElementById('quote-link').href = publicLink;
        document.getElementById('quote-link').textContent = publicLink;
        document.getElementById('quote-link-box').classList.remove('hidden');

        alert('Quote saved successfully!\n\nShare this link with your client:\n' + publicLink);
      } catch (err) {
        console.error('Quote save failed:', err);
        alert('Failed to save quote: ' + err.message);
      }
    });

    const suggestionsBox = document.getElementById("address-suggestions");
    let debounceTimer = null;

    // Listen for typing
    addressInput.addEventListener("input", (e) => {
      const value = e.target.value.trim();

      clearTimeout(debounceTimer);

      if (value.length < 3) {
        hideSuggestions();
        return;
      }

      debounceTimer = setTimeout(() => {
        fetchSuggestions(value);
      }, 250); // debounce
    });

    async function fetchSuggestions(query) {
      try {
        const res = await fetch(
          `${WORKER_URL}/api/address-suggest?q=${encodeURIComponent(query)}`
        );

        if (!res.ok) return;

        const data = await res.json();
        renderSuggestions(data.addresses || []);
      } catch (err) {
        console.warn("Suggest failed", err);
      }
    }

    function renderSuggestions(addresses) {
      suggestionsBox.innerHTML = "";

      if (!addresses.length) {
        hideSuggestions();
        return;
      }

      addresses.forEach(addr => {
        const div = document.createElement("div");
        div.className = "suggestion-item";
        div.textContent = addr.FullAddress;

        div.addEventListener("click", () => {
          addressInput.value = addr.FullAddress;
          hideSuggestions();
        });

        suggestionsBox.appendChild(div);
      });

      suggestionsBox.classList.remove("hidden");
    }

    function hideSuggestions() {
      suggestionsBox.classList.add("hidden");
      suggestionsBox.innerHTML = "";
    }

    // Hide dropdown when clicking elsewhere
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".input-group")) {
        hideSuggestions();
      }
    });


  </script>
>>>>>>> 1481662c6aba3ee1d2e246ec0f98751fc74a4b05
</body>
</html>