<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <title>Jobs • Deep Edge</title>
  <link rel="stylesheet" href="styles.css">
  <script src="header.js" defer></script>

  <style>
    /* Job card enhancements — can be moved to styles.css later */
    .job-card {
      background: linear-gradient(to top, #000000 0%, #0f0f0f 100%);
      border-top: 1px solid #333;
      border-bottom: 1px solid #333;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 28px;
      position: relative;
      transition: all 0.25s ease;
    }
    .job-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(139, 92, 246, 0.18);
    }

    .job-summary {
      margin-bottom: 18px;
    }
    .job-address {
      font-size: 1.38rem;
      font-weight: 700;
      color: #a78bfa;
      margin-bottom: 6px;
    }
    .job-client {
      font-size: 1.05rem;
      color: #d1d5db;
      margin-bottom: 12px;
    }
    .job-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 16px 24px;
      font-size: 0.95rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }
    .meta-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 0.9rem;
    }
    .status-lead     { background: #4b5563; color: white; }
    .status-quoted   { background: #7c3aed44; color: #c4b5fd; }
    .status-won      { background: #166534; color: #86efac; }
    .status-progress { background: #b45309; color: #fcd34d; }
    .status-completed{ background: #14532d; color: #6ee7b7; }
    .status-invoiced { background: #1e40af; color: #93c5fd; }
    .status-paid     { background: #166534; color: #86efac; }
    .status-problem  { background: #991b1b; color: #fca5a5; }

    .job-value {
      font-weight: 600;
      color: #86efac;
    }

    .actions-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 16px 0 20px;
    }
    .action-btn {
      flex: 1;
      min-width: 140px;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }
    .btn-primary {
      background: #28a745;
      color: white;
    }
    .btn-primary:hover { background: #218838; }
    .btn-secondary {
      background: #412e75;
      color: white;
    }
    .btn-secondary:hover { background: #513690; }
    .btn-outline {
      background: transparent;
      border: 1px solid #8B5CF6;
      color: #8B5CF6;
    }
    .btn-outline:hover {
      background: rgba(139, 92, 246, 0.15);
    }

    /* Collapsible - keeping your existing style pattern */
    .collapsible-header {
      background: #2a2a2a;
      padding: 14px 18px;
      border-radius: 8px;
      cursor: pointer;
      margin: 12px 0 8px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .collapsible-header:hover { background: #333; }
    .collapsible-header::after {
      content: '▼';
      transition: transform 0.3s;
    }
    .collapsible-header.open::after { transform: rotate(180deg); }
    .collapsible-content {
      display: none;
      padding: 8px 0;
    }
    .collapsible-content.open { display: block; }
  </style>
</head>
<body>

  <div class="your-quotes-container">
    <h1>Your Jobs</h1>

    <div id="loading" style="text-align:center; padding:40px; color:#8B5CF6;">
      Loading your jobs...
    </div>

    <div id="job-list"></div>

    <div id="no-jobs" class="no-quotes hidden">
      No jobs yet.<br><br>
      Start by creating a quote in the 
      <a href="create_quote.html" style="color:#8B5CF6; text-decoration:underline;">Lawn Calculator</a>!
    </div>
  </div>

  <script>
    // Dummy data (unchanged)
    const dummyJobs = [
      {
        id: "job_abc123",
        address: "42 Sunrise Blvd, Albany, Auckland",
        client: { firstName: "Sarah", lastName: "Thompson", phone: "021 123 4567" },
        createdAt: "2026-01-01T09:30:00Z",
        status: "progress",
        nextAction: "Service scheduled: 22–23 Jan 2026",
        quotedTotal: 2450,
        invoicedTotal: 1200,
        paidTotal: 0,
        quotes: [
          { number: "Q-0251", date: "5 Jan", total: 2450, link: "#" },
          { number: "Q-0263", date: "12 Jan", total: 2380, link: "#" }
        ],
        invoices: [
          { number: "INV-0017", date: "15 Jan", total: 1200, status: "Pending", link: "#" }
        ]
      },
      {
        id: "job_def456",
        address: "17 Ocean View Rd, Takapuna",
        client: { firstName: "Michael", lastName: "Chen" },
        createdAt: "2026-01-10T14:15:00Z",
        status: "quoted",
        nextAction: "Follow-up call due today",
        quotedTotal: 875,
        invoicedTotal: 0,
        paidTotal: 0,
        quotes: [{ number: "Q-0312", date: "12 Jan", total: 875, link: "#" }],
        invoices: []
      },
      {
        id: "job_ghi789",
        address: "8A Park Rise, Remuera",
        client: { firstName: "Emma", lastName: "Wilson" },
        createdAt: "2025-12-20T11:00:00Z",
        status: "paid",
        nextAction: "Job completed – ready for next cycle",
        quotedTotal: 2100,
        invoicedTotal: 2100,
        paidTotal: 2100,
        quotes: [{ number: "Q-0347", date: "22 Dec", total: 2100, link: "#" }],
        invoices: [{ number: "INV-0021", date: "5 Jan", total: 2100, status: "Paid", link: "#" }]
      }
    ];

    // Status options + their display names + suggested next action
    const statusOptions = [
      { value: "lead",      label: "Lead",        colorClass: "status-lead",      nextAction: "Send first quote" },
      { value: "quoted",    label: "Quoted",      colorClass: "status-quoted",    nextAction: "Follow up with client" },
      { value: "won",       label: "Job Won",     colorClass: "status-won",       nextAction: "Schedule service" },
      { value: "progress",  label: "In Progress", colorClass: "status-progress", nextAction: "Service in progress" },
      { value: "completed", label: "Completed",   colorClass: "status-completed", nextAction: "Prepare invoice" },
      { value: "invoiced",  label: "Invoiced",    colorClass: "status-invoiced",  nextAction: "Await payment" },
      { value: "paid",      label: "Paid",        colorClass: "status-paid",      nextAction: "Job complete ✓" },
      { value: "problem",   label: "Problem",     colorClass: "status-problem",   nextAction: "Contact client urgently" }
    ];

    let currentJobs = [...dummyJobs]; // working copy we can mutate

    function renderJobs(jobs) {
      const container = document.getElementById('job-list');
      container.innerHTML = '';

      if (jobs.length === 0) {
        document.getElementById('no-jobs').classList.remove('hidden');
        return;
      }

      const today = new Date();
      jobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      container.innerHTML = jobs.map(job => {
        const created = new Date(job.createdAt);
        const ageDays = Math.floor((today - created) / (1000*60*60*24));
        const ageText = ageDays <= 0 ? "Today" : ageDays === 1 ? "1 day ago" : `${ageDays} days ago`;

        const currentStatus = statusOptions.find(s => s.value === job.status) || statusOptions[1];
        const valueText = job.quotedTotal 
          ? `Quoted $${job.quotedTotal.toFixed(0)}${job.paidTotal ? ` • Paid $${job.paidTotal.toFixed(0)}` : ''}`
          : "Not quoted yet";

        const clientName = job.client?.firstName 
          ? `${job.client.firstName} ${job.client.lastName?.[0]?.toUpperCase() || ''}`
          : "Unknown Client";

        return `
          <div class="job-card" data-job-id="${job.id}">
            <div class="job-summary">
              <div class="job-address">${job.address}</div>
              <div class="job-client">${clientName}${job.client?.phone ? ` • ${job.client.phone}` : ''}</div>
              
              <div class="job-meta">
                <div class="meta-item">
                  <span class="status-badge ${currentStatus.colorClass}">${currentStatus.label}</span>
                </div>
                <div class="meta-item job-value">${valueText}</div>
                <div class="meta-item">${ageText}</div>
              </div>

              ${job.nextAction ? `<div style="color:#c4b5fd; font-weight:500;">${job.nextAction}</div>` : ''}
            </div>

            <div class="actions-bar">
              <button class="action-btn btn-primary">Schedule Service</button>
              <button class="action-btn btn-secondary">New Quote</button>
              <button class="action-btn btn-outline">Create Invoice</button>
              <button class="action-btn btn-outline update-status-btn">Update Status</button>
            </div>

            <!-- Quotes collapsible (unchanged) -->
            <div class="collapsible-header" data-target="quotes-${job.id}">
              Quotes (${job.quotes.length})
            </div>
            <div class="collapsible-content" id="quotes-${job.id}">
              ${job.quotes.map(q => `
                <div class="quote-item" style="background:rgba(40,40,60,0.4); padding:12px; border-radius:8px; margin:8px 0;">
                  <strong>${q.number}</strong> • ${q.date} • $${q.total.toFixed(2)}
                  <div style="margin-top:6px;">
                    <a href="${q.link}" style="color:#8B5CF6;">View</a>
                  </div>
                </div>
              `).join('') || '<p style="color:#9ca3af; padding:12px;">No quotes yet</p>'}
            </div>

            <!-- Invoices collapsible (unchanged) -->
            <div class="collapsible-header" data-target="invoices-${job.id}">
              Invoices (${job.invoices.length})
            </div>
            <div class="collapsible-content" id="invoices-${job.id}">
              ${job.invoices.map(inv => `
                <div class="invoice-item" style="background:rgba(40,40,60,0.4); padding:12px; border-radius:8px; margin:8px 0;">
                  <strong>${inv.number}</strong> • ${inv.date} • $${inv.total.toFixed(2)} • ${inv.status}
                  <div style="margin-top:6px;">
                    <a href="${inv.link}" style="color:#8B5CF6;">View</a>
                  </div>
                </div>
              `).join('') || '<p style="color:#9ca3af; padding:12px;">No invoices yet</p>'}
            </div>
          </div>
        `;
      }).join('');

      // Collapsible toggle (unchanged)
      document.querySelectorAll('.collapsible-header').forEach(h => {
        h.addEventListener('click', () => {
          const target = document.getElementById(h.dataset.target);
          h.classList.toggle('open');
          target.classList.toggle('open');
        });
      });

      // NEW: Update Status button handlers
      document.querySelectorAll('.update-status-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const card = btn.closest('.job-card');
          const jobId = card.dataset.jobId;
          const job = currentJobs.find(j => j.id === jobId);
          if (!job) return;

          showStatusModal(job);
        });
      });
    }

    // Simple modal for status update
    function showStatusModal(job) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999;
        display: flex; align-items: center; justify-content: center;
      `;

      const current = statusOptions.find(s => s.value === job.status) || statusOptions[1];

      modal.innerHTML = `
        <div style="
          background: #1f1f1f; border-radius: 12px; padding: 28px; max-width: 420px; width: 90%;
          color: white; box-shadow: 0 12px 40px rgba(0,0,0,0.7);
        ">
          <h3 style="margin:0 0 20px; color:#8B5CF6;">Update Job Status</h3>
          <p style="margin:0 0 16px; color:#d1d5db;">
            Current status: <strong>${current.label}</strong>
          </p>
          
          <select id="newStatusSelect" style="
            width:100%; padding:12px; background:#2a2a2a; color:white; border:1px solid #444;
            border-radius:8px; font-size:1rem; margin-bottom:20px;
          ">
            ${statusOptions.map(opt => `
              <option value="${opt.value}" ${opt.value === job.status ? 'selected' : ''}>
                ${opt.label}
              </option>
            `).join('')}
          </select>

          <div style="display:flex; gap:12px; justify-content:flex-end;">
            <button id="cancelStatusBtn" style="
              padding:10px 20px; background:#333; color:white; border:none; border-radius:8px; cursor:pointer;
            ">Cancel</button>
            <button id="saveStatusBtn" style="
              padding:10px 20px; background:#8B5CF6; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:600;
            ">Update Status</button>
          </div>
        </div>
      `;

      document.body.appendChild(modal);

      // Cancel
      modal.querySelector('#cancelStatusBtn').onclick = () => modal.remove();

      // Save
      modal.querySelector('#saveStatusBtn').onclick = () => {
        const newValue = modal.querySelector('#newStatusSelect').value;
        const newStatus = statusOptions.find(s => s.value === newValue);

        if (newStatus) {
          job.status = newStatus.value;
          const suggestedNext = newStatus.nextAction;
          if (suggestedNext) {
            job.nextAction = suggestedNext;
          }

          // Re-render everything
          renderJobs(currentJobs);
        }

        modal.remove();
      };

      // Close on outside click
      modal.onclick = e => {
        if (e.target === modal) modal.remove();
      };
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('loading').classList.add('hidden');
      setTimeout(() => renderJobs(currentJobs), 600);
    });
    </script>
</body>
</html>